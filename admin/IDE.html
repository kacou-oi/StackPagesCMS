<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDE - Pages Frame IDE - StackPages CMS</title>
    <link rel="icon" type="image/x-icon" href="https://stackpages.net/img/logo.png">
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Monaco Editor -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Prism.js for Code Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Monaco Editor container */
        #monaco-editor-container {
            width: 100%;
            height: 100%;
            min-height: 400px;
        }
    </style>
</head>

<body class="font-sans antialiased bg-[#1e1e1e]">
    <!-- Header -->
    <header class="bg-gradient-to-r from-slate-900 to-slate-800 text-white shadow-lg border-b border-slate-700">
        <div class="flex items-center justify-between px-6 py-4">
            <div class="flex items-center gap-4">
                <a href="/admin/dashboard.html" class="text-slate-400 hover:text-orange-500 transition"
                    title="Retour au dashboard">
                    <i class="fas fa-arrow-left text-xl"></i>
                </a>
                <div>
                    <h1 class="text-xl font-bold text-white">Pages Frame IDE</h1>
                    <p class="text-sm text-slate-400" id="page-status">Nouvelle page</p>
                </div>
            </div>

            <!-- Domain Display -->
            <div class="flex-1 flex justify-center">
                <span id="site-domain" class="text-2xl font-bold text-white tracking-wide"></span>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="previewPageNewTab()"
                    class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-medium transition flex items-center gap-2">
                    <i class="fas fa-external-link-alt"></i> Aperçu
                </button>
                <button onclick="savePage('draft')"
                    class="px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg font-medium transition flex items-center gap-2">
                    <i class="far fa-save"></i> Brouillon
                </button>
                <button onclick="savePage('published')"
                    class="px-4 py-2 bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white rounded-lg font-medium transition shadow-md hover:shadow-lg flex items-center gap-2">
                    <i class="fas fa-check"></i> Publier
                </button>

                <!-- Switch Mode Button -->
                <button onclick="switchToVisual()"
                    class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded-lg font-medium transition flex items-center gap-2 border border-slate-600 ml-2">
                    <i class="fas fa-paint-brush"></i>
                    <span>Switch to Visual</span>
                </button>
            </div>
    </header>

    <!-- Main Layout -->
    <main class="flex" style="height: calc(100vh - 73px);">
        <!-- Left Panel - Page Settings -->
        <div class="w-80 bg-[#252526] border-r border-slate-700 overflow-y-auto flex-shrink-0">
            <div class="p-6">
                <h2 class="text-lg font-bold text-white mb-6 flex items-center gap-2">
                    <i class="fas fa-cog text-orange-400"></i>
                    Paramètres de la Page
                </h2>

                <form id="page-creator-form" class="space-y-4">
                    <!-- Title -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-300 mb-2">
                            Titre de la Page <span class="text-red-400">*</span>
                        </label>
                        <input type="text" id="page-title" required placeholder="Ex: À propos de nous"
                            class="w-full px-3 py-2 bg-[#1e1e1e] border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition">
                    </div>

                    <!-- Slug -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-300 mb-2">
                            Slug URL
                        </label>
                        <input type="text" id="page-slug" readonly placeholder="a-propos-de-nous"
                            class="w-full px-3 py-2 bg-[#333333] border border-slate-600 rounded-lg text-slate-400 cursor-not-allowed">
                        <p class="text-xs text-slate-500 mt-1">Généré automatiquement</p>
                    </div>

                    <!-- Meta Description -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-300 mb-2">
                            Meta Description
                        </label>
                        <textarea id="page-meta-desc" rows="3"
                            placeholder="Description courte pour les moteurs de recherche..."
                            class="w-full px-3 py-2 bg-[#1e1e1e] border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition resize-none"></textarea>
                    </div>

                    <!-- Meta Keywords -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-300 mb-2">
                            Meta Keywords
                        </label>
                        <input type="text" id="page-meta-keywords" placeholder="mot-clé1, mot-clé2, mot-clé3"
                            class="w-full px-3 py-2 bg-[#1e1e1e] border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition">
                    </div>

                    <!-- Thumbnail -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-300 mb-2">
                            Image Thumbnail (URL)
                        </label>
                        <input type="url" id="page-thumbnail" placeholder="https://example.com/image.jpg"
                            class="w-full px-3 py-2 bg-[#1e1e1e] border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition">
                    </div>

                    <div class="pt-4 border-t border-slate-700">
                        <!-- Reset Button -->
                        <button type="button" onclick="clearPageForm()"
                            class="w-full py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-medium transition flex items-center justify-center gap-2">
                            <i class="fas fa-redo"></i> Réinitialiser le formulaire
                        </button>
                    </div>

                    <div id="page-save-status" class="text-sm"></div>
                </form>
            </div>
        </div>

        <!-- Right Panel - Code Editor -->
        <div class="flex-1 flex flex-col bg-[#1e1e1e]">
            <!-- Code Editor Header -->
            <div class="px-6 py-4 border-b border-slate-700 bg-[#252526] flex justify-between items-center">
                <h3 class="font-semibold text-slate-200 flex items-center gap-2">
                    <i class="fas fa-code text-orange-500"></i>
                    Éditeur HTML
                </h3>

                <!-- Gemini Branding -->
                <div class="flex items-center gap-3 bg-[#1e1e1e] px-4 py-1.5 rounded-full border border-slate-700">
                    <img src="https://img.icons8.com/fluency/48/gemini-ai.png" alt="Gemini" class="w-5 h-5">
                    <span class="font-bold text-slate-200 text-sm">Powered by Google Gemini</span>
                    <button onclick="openGeminiConfig()" class="ml-2 text-slate-400 hover:text-white transition"
                        title="Configurer l'API Gemini">
                        <i class="fas fa-cog text-lg hover:rotate-90 transition-transform duration-500"></i>
                    </button>
                </div>

                <div class="flex items-center gap-3">
                    <span id="html-char-count" class="text-xs text-slate-400 mr-2">0 caractères</span>
                    <button onclick="openPromptModal()"
                        class="px-3 py-1.5 bg-[#333333] border border-slate-600 rounded-md text-sm text-slate-200 hover:bg-[#444444] transition flex items-center gap-2">
                        <i class="fas fa-magic"></i> Prompt
                    </button>
                </div>
            </div>

            <!-- CMS Navigation Tabs -->
            <div class="px-6 py-3 border-b border-slate-700 bg-[#252526] flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <button onclick="switchView('templates')" id="tab-templates"
                        class="px-4 py-2 rounded-md font-medium transition flex items-center gap-2 bg-slate-700 text-white">
                        <i class="fas fa-layer-group"></i> Templates
                    </button>
                    <button onclick="switchView('contents')" id="tab-contents"
                        class="px-4 py-2 rounded-md font-medium transition flex items-center gap-2 bg-transparent hover:bg-slate-700 text-slate-400">
                        <i class="fas fa-file-alt"></i> Contenus
                    </button>
                </div>

                <button onclick="createNewTemplate()" id="btn-new-template"
                    class="px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white rounded-md font-medium transition flex items-center gap-2 shadow-lg">
                    <i class="fas fa-magic"></i> Générer Template avec IA
                </button>

                <button onclick="createNewContent()" id="btn-new-content" style="display: none;"
                    class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md font-medium transition flex items-center gap-2">
                    <i class="fas fa-plus"></i> Nouveau Contenu
                </button>
            </div>

            <!-- Views Container -->
            <div class="flex-1 overflow-hidden flex flex-col">
                <!-- Templates View -->
                <div id="view-templates" class="flex-1 overflow-y-auto p-6 bg-[#1e1e1e]">
                    <div id="templates-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Templates will be rendered here -->
                        <div class="col-span-full text-center py-12 text-slate-500">
                            <i class="fas fa-layer-group text-6xl mb-4 opacity-20"></i>
                            <p class="text-lg">Aucun template pour le moment</p>
                            <p class="text-sm mt-2">Cliquez sur "Générer Template avec IA" pour commencer</p>
                        </div>
                    </div>
                </div>

                <!-- Contents View -->
                <div id="view-contents" style="display: none;" class="flex-1 overflow-y-auto p-6 bg-[#1e1e1e]">
                    <div class="mb-4">
                        <label class="block text-sm text-slate-400 mb-2">Filtrer par template :</label>
                        <select id="filter-template" onchange="renderContents()"
                            class="w-64 px-3 py-2 bg-[#252526] border border-slate-600 rounded-md text-white">
                            <option value="">Tous les templates</option>
                        </select>
                    </div>

                    <div id="contents-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Contents will be rendered here -->
                        <div class="col-span-full text-center py-12 text-slate-500">
                            <i class="fas fa-file-alt text-6xl mb-4 opacity-20"></i>
                            <p class="text-lg">Aucun contenu pour le moment</p>
                            <p class="text-sm mt-2">Créez d'abord un template, puis ajoutez des contenus</p>
                        </div>
                    </div>
                </div>
            </div>


            <div class="px-6 py-3 border-t border-slate-700 bg-[#252526] flex items-center justify-between">
                <span class="text-xs text-slate-400">
                    <i class="fas fa-keyboard text-orange-400 mr-1"></i>
                    Monaco Editor - Coloration syntaxique automatique
                </span>
                <div class="flex items-center gap-4">
                    <span id="page-status-badge" class="text-xs px-2 py-1 rounded bg-slate-700 text-slate-300">
                        <i class="fas fa-circle text-green-500 mr-1" style="font-size: 6px;"></i>
                        Prêt
                    </span>
                    <span id="html-char-count" class="text-xs text-slate-500">0 caractères</span>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Preview -->
    <div id="preview-modal"
        class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 id="modal-title" class="font-bold text-lg text-slate-800 truncate pr-4">Aperçu de la page</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="modal-content" class="p-8 overflow-y-auto prose prose-orange max-w-none">
                <!-- Content -->
            </div>
        </div>
    </div>

    <!-- Prompt Modal -->
    <div id="prompt-modal"
        class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-[#1e1e1e] rounded-xl shadow-2xl w-full max-w-2xl border border-slate-700 transform transition-all scale-100 flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-700 flex justify-between items-center bg-[#252526] rounded-t-xl">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <i class="fas fa-magic text-purple-400"></i>
                    Générer avec Gemini
                </h3>
                <button onclick="closePromptModal()" class="text-slate-400 hover:text-white transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="p-6 flex-1 overflow-y-auto">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-300 mb-2">
                        Décrivez la page ou le composant que vous souhaitez créer
                    </label>
                    <textarea id="gemini-prompt-input" rows="6"
                        placeholder="Ex: Crée une landing page moderne pour un café avec une section héro, une galerie de photos et un formulaire de contact. Utilise des couleurs chaudes."
                        class="w-full px-4 py-3 bg-[#252526] border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition resize-none text-base"></textarea>
                </div>

                <div id="generation-error"
                    class="hidden mb-4 p-3 bg-red-900/50 border border-red-700 rounded-lg text-red-200 text-sm flex items-center gap-2">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="generation-error-msg">Une erreur est survenue.</span>
                </div>

                <div class="bg-blue-900/20 border border-blue-800 rounded-lg p-4 mb-2">
                    <p class="text-sm text-blue-200 flex items-start gap-2">
                        <i class="fas fa-info-circle mt-0.5"></i>
                        <span>Le code généré remplacera le contenu actuel de l'éditeur. Assurez-vous d'avoir sauvegardé
                            votre travail si nécessaire.</span>
                    </p>
                </div>
            </div>

            <div class="p-6 border-t border-slate-700 bg-[#252526] rounded-b-xl flex justify-end gap-3">
                <button onclick="closePromptModal()"
                    class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-medium transition">
                    Annuler
                </button>
                <button onclick="generateCode()" id="generate-btn"
                    class="px-6 py-2 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white rounded-lg font-bold transition shadow-lg shadow-purple-500/20 flex items-center gap-2">
                    <span id="generate-btn-text">Générer le code</span>
                    <i id="generate-btn-icon" class="fas fa-wand-magic-sparkles"></i>
                    <i id="generate-loading" class="fas fa-circle-notch fa-spin hidden"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Gemini Config Modal -->
    <div id="gemini-modal"
        class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-[#1e1e1e] rounded-xl shadow-2xl w-full max-w-md border border-slate-700 transform transition-all scale-100">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        <img src="https://img.icons8.com/fluency/48/gemini-ai.png" alt="Gemini" class="w-6 h-6">
                        Configuration Gemini
                    </h3>
                    <button onclick="closeGeminiConfig()" class="text-slate-400 hover:text-white transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Clé API Gemini</label>
                        <div class="relative">
                            <input type="password" id="gemini-api-key" placeholder="Collez votre clé API ici..."
                                class="w-full pl-10 pr-4 py-2.5 bg-[#252526] border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition placeholder-slate-500">
                            <i class="fas fa-key absolute left-3 top-3 text-slate-500"></i>
                        </div>
                    </div>

                    <div class="bg-[#252526] rounded-lg p-4 border border-slate-700">
                        <p class="text-sm text-slate-300 mb-2 font-medium">Comment obtenir une clé :</p>
                        <ol class="list-decimal list-inside space-y-1.5 text-sm text-slate-400 ml-1">
                            <li>Allez sur <a href="https://makersuite.google.com/app/apikey" target="_blank"
                                    class="text-blue-400 hover:text-blue-300 hover:underline">Google AI Studio</a></li>
                            <li>Créez une clé API gratuite</li>
                            <li>Copiez et collez-la ci-dessus</li>
                        </ol>
                    </div>

                    <div class="pt-1">
                        <a href="https://www.youtube.com/watch?v=example" target="_blank"
                            class="flex items-center gap-2 text-red-400 hover:text-red-300 text-sm font-medium group">
                            <div
                                class="w-6 h-6 bg-red-500/10 rounded-full flex items-center justify-center group-hover:bg-red-500/20 transition">
                                <i class="fab fa-youtube"></i>
                            </div>
                            VIDEO TUTO : Comment configurer Gemini
                        </a>
                    </div>

                    <button onclick="saveGeminiConfig()"
                        class="w-full py-2.5 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white rounded-lg font-bold transition shadow-lg shadow-blue-500/20 flex items-center justify-center gap-2">
                        <i class="fas fa-save"></i>
                        Sauvegarder la configuration
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Creation/Edition Modal -->
    <div id="content-modal"
        class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-[#1e1e1e] rounded-xl shadow-2xl w-full max-w-3xl border border-slate-700 flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-700 flex justify-between items-center bg-[#252526] rounded-t-xl">
                <h3 id="content-modal-title" class="text-xl font-bold text-white flex items-center gap-2">
                    <i class="fas fa-file-alt text-blue-400"></i>
                    Nouveau Contenu
                </h3>
                <button onclick="closeContentModal()" class="text-slate-400 hover:text-white transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="p-6 flex-1 overflow-y-auto space-y-4">
                <!-- Template Selection -->
                <div id="template-selection-div">
                    <label class="block text-sm font-medium text-slate-300 mb-2">
                        Template <span class="text-red-400">*</span>
                    </label>
                    <select id="content-template-select" onchange="loadTemplateFields()"
                        class="w-full px-4 py-2.5 bg-[#252526] border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500">
                        <option value="">Sélectionnez un template...</option>
                    </select>
                </div>

                <!-- Slug -->
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">
                        Slug URL <span class="text-slate-500 text-xs">(généré automatiquement si vide)</span>
                    </label>
                    <input type="text" id="content-slug" placeholder="mon-article"
                        class="w-full px-4 py-2.5 bg-[#252526] border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Dynamic Fields Container -->
                <div id="content-fields-container" class="space-y-4">
                    <div class="text-center py-8 text-slate-500">
                        <i class="fas fa-info-circle text-3xl mb-2 opacity-20"></i>
                        <p>Sélectionnez un template pour voir les champs</p>
                    </div>
                </div>
            </div>

            <div class="p-6 border-t border-slate-700 bg-[#252526] rounded-b-xl flex justify-between gap-3">
                <button onclick="closeContentModal()"
                    class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-medium transition">
                    Annuler
                </button>
                <div class="flex gap-3">
                    <button onclick="saveContent('draft')" id="save-draft-btn"
                        class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-medium transition">
                        <i class="far fa-save"></i> Brouillon
                    </button>
                    <button onclick="saveContent('published')" id="publish-btn"
                        class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold transition shadow-lg">
                        <i class="fas fa-check"></i> Publier
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="./../core/admin.js"></script>
    <script>
        // Global Monaco Editor instance (accessible from admin.js)
        let monacoEditor = null;
        window.monacoEditor = null;

        // Initialize Monaco Editor
        function initMonacoEditor(initialValue = '') {
            require.config({
                paths: {
                    vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs'
                }
            });

            require(['vs/editor/editor.main'], function () {
                monacoEditor = monaco.editor.create(document.getElementById('monaco-editor-container'), {
                    value: initialValue,
                    language: 'html',
                    theme: 'vs-dark',
                    automaticLayout: true,
                    fontSize: 14,
                    lineNumbers: 'on',
                    minimap: { enabled: false },
                    scrollBeyondLastLine: false,
                    wordWrap: 'on',
                    tabSize: 2,
                    insertSpaces: true,
                    formatOnPaste: true,
                    formatOnType: true,
                    suggest: {
                        snippetsPreventQuickSuggestions: false
                    }
                });

                // Make globally accessible
                window.monacoEditor = monacoEditor;

                // Update character count on content change
                monacoEditor.onDidChangeModelContent(() => {
                    updateCharacterCount();
                    updateStatusBadge();
                });

                // Initial character count
                updateCharacterCount();
            });
        }

        // ====================================================================
        // CMS ARCHITECTURE - TEMPLATES & CONTENTS
        // ====================================================================

        // ============= TEMPLATE RENDERER =============
        class TemplateRenderer {
            /**
             * Renders a template with data
             * Supports {{field}} and {{{htmlField}}} syntax
             */
            render(htmlTemplate, data) {
                if (!htmlTemplate || !data) return '';

                let result = htmlTemplate;

                // Replace {{field}} with escaped data
                Object.keys(data).forEach(key => {
                    const escapedValue = this.escapeHtml(data[key]);
                    const regex = new RegExp(`{{${key}}}`, 'g');
                    result = result.replace(regex, escapedValue);
                });

                // Replace {{{field}}} with raw HTML
                Object.keys(data).forEach(key => {
                    const rawValue = data[key] || '';
                    const regex = new RegExp(`{{{${key}}}}`, 'g');
                    result = result.replace(regex, rawValue);
                });

                return result;
            }

            escapeHtml(text) {
                if (typeof text !== 'string') return text;
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // ============= TEMPLATE MANAGER =============
        class TemplateManager {
            constructor() {
                this.templates = [];
                this.load();
            }

            generateId() {
                return 'template_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            create(data) {
                const template = {
                    id: this.generateId(),
                    name: data.name || 'New Template',
                    description: data.description || '',
                    category: data.category || 'content',
                    fields: data.fields || [],
                    htmlTemplate: data.htmlTemplate || '',
                    createdAt: new Date().toISOString()
                };

                this.templates.push(template);
                this.save();
                return template;
            }

            update(id, data) {
                const index = this.templates.findIndex(t => t.id === id);
                if (index === -1) return null;

                this.templates[index] = {
                    ...this.templates[index],
                    ...data,
                    id: id, // Preserve ID
                    updatedAt: new Date().toISOString()
                };

                this.save();
                return this.templates[index];
            }

            delete(id) {
                const index = this.templates.findIndex(t => t.id === id);
                if (index === -1) return false;

                this.templates.splice(index, 1);
                this.save();
                return true;
            }

            get(id) {
                return this.templates.find(t => t.id === id);
            }

            list() {
                return this.templates;
            }

            save() {
                localStorage.setItem('cms_templates', JSON.stringify(this.templates));
            }

            load() {
                const stored = localStorage.getItem('cms_templates');
                if (stored) {
                    try {
                        this.templates = JSON.parse(stored);
                    } catch (e) {
                        console.error('Error loading templates:', e);
                        this.templates = [];
                    }
                }
            }
        }

        // ============= CONTENT MANAGER =============
        class ContentManager {
            constructor() {
                this.contents = [];
                this.load();
            }

            generateId() {
                return 'content_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            generateSlug(title) {
                return title.toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/(^-|-$)/g, '');
            }

            create(templateId, data, slug = null) {
                const content = {
                    id: this.generateId(),
                    templateId: templateId,
                    status: 'draft',
                    data: data,
                    slug: slug || this.generateSlug(data.title || 'untitled'),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                this.contents.push(content);
                this.save();
                return content;
            }

            update(id, updates) {
                const index = this.contents.findIndex(c => c.id === id);
                if (index === -1) return null;

                this.contents[index] = {
                    ...this.contents[index],
                    ...updates,
                    id: id, // Preserve ID
                    updatedAt: new Date().toISOString()
                };

                this.save();
                return this.contents[index];
            }

            delete(id) {
                const index = this.contents.findIndex(c => c.id === id);
                if (index === -1) return false;

                this.contents.splice(index, 1);
                this.save();
                return true;
            }

            get(id) {
                return this.contents.find(c => c.id === id);
            }

            listByTemplate(templateId) {
                return this.contents.filter(c => c.templateId === templateId);
            }

            list() {
                return this.contents;
            }

            publish(id) {
                return this.update(id, { status: 'published' });
            }

            unpublish(id) {
                return this.update(id, { status: 'draft' });
            }

            save() {
                localStorage.setItem('cms_contents', JSON.stringify(this.contents));
            }

            load() {
                const stored = localStorage.getItem('cms_contents');
                if (stored) {
                    try {
                        this.contents = JSON.parse(stored);
                    } catch (e) {
                        console.error('Error loading contents:', e);
                        this.contents = [];
                    }
                }
            }
        }

        // ============= GLOBAL INSTANCES =============
        let templateManager = null;
        let contentManager = null;
        let templateRenderer = null;

        // Initialize CMS
        function initCMS() {
            templateManager = new TemplateManager();
            contentManager = new ContentManager();
            templateRenderer = new TemplateRenderer();

            console.log('CMS initialized:', {
                templates: templateManager.list().length,
                contents: contentManager.list().length
            });
        }

        // ====================================================================
        // VIEW MANAGEMENT (Templates / Contents)
        // ====================================================================

        let currentView = 'templates';

        function switchView(viewName) {
            currentView = viewName;

            // Hide all views
            document.getElementById('view-templates').style.display = 'none';
            document.getElementById('view-contents').style.display = 'none';

            // Show selected view
            document.getElementById(`view-${viewName}`).style.display = 'flex';

            // Update tab styles
            document.getElementById('tab-templates').className = 'px-4 py-2 rounded-md font-medium transition flex items-center gap-2 ' +
                (viewName === 'templates' ? 'bg-slate-700 text-white' : 'bg-transparent hover:bg-slate-700 text-slate-400');
            document.getElementById('tab-contents').className = 'px-4 py-2 rounded-md font-medium transition flex items-center gap-2 ' +
                (viewName === 'contents' ? 'bg-slate-700 text-white' : 'bg-transparent hover:bg-slate-700 text-slate-400');

            // Toggle action buttons
            document.getElementById('btn-new-template').style.display = viewName === 'templates' ? 'flex' : 'none';
            document.getElementById('btn-new-content').style.display = viewName === 'contents' ? 'flex' : 'none';

            // Render appropriate content
            if (viewName === 'templates') {
                renderTemplates();
            } else if (viewName === 'contents') {
                renderContents();
            }
        }

        // Render templates list
        function renderTemplates() {
            const container = document.getElementById('templates-list');
            const templates = templateManager.list();

            if (templates.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12 text-slate-500">
                        <i class="fas fa-layer-group text-6xl mb-4 opacity-20"></i>
                        <p class="text-lg">Aucun template pour le moment</p>
                        <p class="text-sm mt-2">Cliquez sur "Générer Template avec IA" pour commencer</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = templates.map(template => {
                const contentCount = contentManager.listByTemplate(template.id).length;
                return `
                    <div class="bg-[#252526] rounded-lg border border-slate-700 hover:border-slate-600 transition p-4">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h3 class="text-white font-semibold text-lg">${template.name}</h3>
                                <p class="text-slate-400 text-sm mt-1">${template.description || 'Aucune description'}</p>
                            </div>
                            <span class="px-2 py-1 bg-blue-900/30 text-blue-300 text-xs rounded">${template.fields.length} champs</span>
                        </div>
                        
                        <div class="flex items-center justify-between text-xs text-slate-500 mb-4">
                            <span><i class="fas fa-file-alt mr-1"></i>${contentCount} contenu(s)</span>
                            <span>${new Date(template.createdAt).toLocaleDateString()}</span>
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick= "editTemplate('${template.id}')" class="flex-1 px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-white text-sm rounded transition">
                                <i class="fas fa-edit"></i> Éditer
                            </button>
                            <button onclick="duplicateTemplate('${template.id}')" class="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-white text-sm rounded transition">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button onclick="deleteTemplate('${template.id}')" class="px-3 py-1.5 bg-red-900/30 hover:bg-red-900/50 text-red-300 text-sm rounded transition">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render contents list
        function renderContents() {
            const container = document.getElementById('contents-list');
            const filterSelect = document.getElementById('filter-template');
            const selectedTemplate = filterSelect.value;

            let contents = contentManager.list();
            if (selectedTemplate) {
                contents = contentManager.listByTemplate(selectedTemplate);
            }

            // Update filter dropdown
            const templates = templateManager.list();
            filterSelect.innerHTML = '<option value="">Tous les templates</option>' +
                templates.map(t => `<option value="${t.id}" ${selectedTemplate === t.id ? 'selected' : ''}>${t.name}</option>`).join('');

            if (contents.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12 text-slate-500">
                        <i class="fas fa-file-alt text-6xl mb-4 opacity-20"></i>
                        <p class="text-lg">Aucun contenu pour le moment</p>
                        <p class="text-sm mt-2">${templates.length === 0 ? 'Créez d\'abord un template, puis ajoutez des contenus' : 'Cliquez sur "Nouveau Contenu" pour ajouter du contenu'}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = contents.map(content => {
                const template = templateManager.get(content.templateId);
                const statusColor = content.status === 'published' ? 'text-green-300 bg-green-900/30' : 'text-orange-300 bg-orange-900/30';

                return `
                    <div class="bg-[#252526] rounded-lg border border-slate-700 hover:border-slate-600 transition p-4">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <h3 class="text-white font-semibold">${content.data.title || 'Sans titre'}</h3>
                                <p class="text-slate-500 text-xs mt-1">${template?.name || 'Template inconnu'}</p>
                            </div>
                            <span class="px-2 py-1 text-xs rounded ${statusColor}">${content.status === 'published' ? 'Publié' : 'Brouillon'}</span>
                        </div>
                        
                        <p class="text-slate-400 text-sm mb-4 line-clamp-2">${content.data.description || content.data.content?.substring(0, 100) || 'Pas de description'}</p>
                        
                        <div class="flex items-center justify-between text-xs text-slate-500 mb-4">
                            <span>${new Date(content.updatedAt).toLocaleDateString()}</span>
                            <span class="text-blue-400">/${content.slug}</span>
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="editContent('${content.id}')" class="flex-1 px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-white text-sm rounded transition">
                                <i class="fas fa-edit"></i> Éditer
                            </button>
                            <button onclick="previewContent('${content.id}')" class="px-3 py-1.5 bg-blue-900/30 hover:bg-blue-900/50 text-blue-300 text-sm rounded transition">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="deleteContent('${content.id}')" class="px-3 py-1.5 bg-red-900/30 hover:bg-red-900/50 text-red-300 text-sm rounded transition">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ====================================================================
        // TEMPLATE ACTIONS
        // ====================================================================

        function createNewTemplate() {
            // Open Gemini prompt modal
            openPromptModal();
        }

        function editTemplate(id) {
            const template = templateManager.get(id);
            if (!template) return;

            // For now, just show an alert - to be implemented later
            alert('Édition de template à implémenter dans la prochaine phase');
        }

        function duplicateTemplate(id) {
            const template = templateManager.get(id);
            if (!template) return;

            const newTemplate = templateManager.create({
                ...template,
                name: template.name + ' (Copie)'
            });

            renderTemplates();
        }

        function deleteTemplate(id) {
            const template = templateManager.get(id);
            if (!template) return;

            if (!confirm(`Supprimer le template "${template.name}" ?\nTous les contenus associés seront également supprimés.`)) return;

            // Delete all contents using this template
            const contents = contentManager.listByTemplate(id);
            contents.forEach(c => contentManager.delete(c.id));

            templateManager.delete(id);
            renderTemplates();
        }

        // ====================================================================
        // CONTENT ACTIONS
        // ==================================================================== 

        let editingContentId = null; // Track if we're editing or creating

        function createNewContent() {
            const templates = templateManager.list();
            if (templates.length === 0) {
                alert('Veuillez d\'abord créer un template');
                return;
            }

            editingContentId = null;
            document.getElementById('content-modal-title').innerHTML = '<i class="fas fa-file-alt text-blue-400"></i> Nouveau Contenu';

            // Populate template dropdown
            const select = document.getElementById('content-template-select');
            select.innerHTML = '<option value="">Sélectionnez un template...</option>' +
                templates.map(t => `<option value="${t.id}">${t.name}</option>`).join('');

            // Show template selection
            document.getElementById('template-selection-div').style.display = 'block';

            // Clear fields
            document.getElementById('content-slug').value = '';
            document.getElementById('content-fields-container').innerHTML = `
                <div class="text-center py-8 text-slate-500">
                    <i class="fas fa-info-circle text-3xl mb-2 opacity-20"></i>
                    <p>Sélectionnez un template pour voir les champs</p>
                </div>
            `;

            // Show modal
            document.getElementById('content-modal').classList.remove('hidden');
        }

        function editContent(id) {
            const content = contentManager.get(id);
            if (!content) return;

            editingContentId = id;
            document.getElementById('content-modal-title').innerHTML = '<i class="fas fa-edit text-blue-400"></i> Éditer Contenu';

            // Populate template dropdown (disabled since template can't change)
            const templates = templateManager.list();
            const select = document.getElementById('content-template-select');
            select.innerHTML = templates.map(t =>
                `<option value="${t.id}" ${t.id === content.templateId ? 'selected' : ''}>${t.name}</option>`
            ).join('');
            select.disabled = true;

            // Hide template selection label (editing, template is locked)
            document.getElementById('template-selection-div').style.display = 'none';

            // Load slug
            document.getElementById('content-slug').value = content.slug;

            // Generate fields for this template and populate with content data
            loadTemplateFields(content.data);

            // Show modal
            document.getElementById('content-modal').classList.remove('hidden');
        }

        function closeContentModal() {
            document.getElementById('content-modal').classList.add('hidden');
            document.getElementById('content-template-select').disabled = false;
            editingContentId = null;
        }

        function loadTemplateFields(existingData = {}) {
            const templateId = document.getElementById('content-template-select').value;
            if (!templateId) {
                document.getElementById('content-fields-container').innerHTML = `
                    <div class="text-center py-8 text-slate-500">
                        <i class="fas fa-info-circle text-3xl mb-2 opacity-20"></i>
                        <p>Sélectionnez un template pour voir les champs</p>
                    </div>
                `;
                return;
            }

            const template = templateManager.get(templateId);
            if (!template || !template.fields) return;

            const container = document.getElementById('content-fields-container');
            container.innerHTML = '';

            template.fields.forEach(field => {
                const fieldDiv = document.createElement('div');
                const value = existingData[field.name] || '';

                const label = `
                    <label class="block text-sm font-medium text-slate-300 mb-2">
                        ${field.name} ${field.required ? '<span class="text-red-400">*</span>' : ''}
                        <span class="text-slate-500 text-xs ml-2">(${field.type})</span>
                    </label>
                `;

                let input = '';
                switch (field.type) {
                    case 'text':
                        input = `<input type="text" id="field-${field.name}" value="${value}" 
                            class="w-full px-4 py-2.5 bg-[#252526] border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500" 
                            ${field.required ? 'required' : ''}>`;
                        break;
                    case 'richtext':
                        input = `<textarea id="field-${field.name}" rows="8" 
                            class="w-full px-4 py-2.5 bg-[#252526] border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 font-mono text-sm" 
                            ${field.required ? 'required' : ''}>${value}</textarea>
                            <p class="text-xs text-slate-500 mt-1">HTML autorisé</p>`;
                        break;
                    case 'date':
                        input = `<input type="date" id="field-${field.name}" value="${value}" 
                            class="w-full px-4 py-2.5 bg-[#252526] border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500" 
                            ${field.required ? 'required' : ''}>`;
                        break;
                    case 'image':
                        input = `<input type="url" id="field-${field.name}" value="${value}" placeholder="https://..." 
                            class="w-full px-4 py-2.5 bg-[#252526] border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500" 
                            ${field.required ? 'required' : ''}>
                            <p class="text-xs text-slate-500 mt-1">URL de l'image</p>`;
                        break;
                    case 'array':
                        const arrayValues = Array.isArray(value) ? value.join(', ') : value;
                        input = `<input type="text" id="field-${field.name}" value="${arrayValues}" placeholder="tag1, tag2, tag3" 
                            class="w-full px-4 py-2.5 bg-[#252526] border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-slate-500 mt-1">Séparez par des virgules</p>`;
                        break;
                    default:
                        input = `<input type="text" id="field-${field.name}" value="${value}" 
                            class="w-full px-4 py-2.5 bg-[#252526] border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500">`;
                }

                fieldDiv.innerHTML = label + input;
                container.appendChild(fieldDiv);
            });
        }

        function saveContent(status) {
            const templateId = document.getElementById('content-template-select').value;
            if (!templateId) {
                alert('Veuillez sélectionner un template');
                return;
            }

            const template = templateManager.get(templateId);
            if (!template) return;

            // Collect data from all fields
            const data = {};
            template.fields.forEach(field => {
                const input = document.getElementById(`field-${field.name}`);
                if (!input) return;

                let value = input.value;

                // Handle array type
                if (field.type === 'array' && value) {
                    value = value.split(',').map(v => v.trim()).filter(v => v);
                }

                // Validation
                if (field.required && (!value || value.length === 0)) {
                    alert(`Le champ "${field.name}" est requis`);
                    input.focus();
                    throw new Error('Validation failed');
                }

                data[field.name] = value;
            });

            const slug = document.getElementById('content-slug').value;

            if (editingContentId) {
                // Update existing content
                contentManager.update(editingContentId, { data, slug, status });
            } else {
                // Create new content
                contentManager.create(templateId, data, slug || null);
            }

            closeContentModal();
            renderContents();

            // Show success notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.textContent = editingContentId ? 'Contenu mis à jour !' : 'Contenu créé !';
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 2000);
        }

        function previewContent(id) {
            const content = contentManager.get(id);
            const template = templateManager.get(content.templateId);

            if (!content || !template) return;

            // Render content with template
            const rendered = templateRenderer.render(template.htmlTemplate, content.data);

            // Open in modal or new window
            const w = window.open('', '_blank');
            w.document.write(rendered);
            w.document.close();
        }

        function deleteContent(id) {
            const content = contentManager.get(id);
            if (!content) return;

            if (!confirm(`Supprimer ce contenu ?`)) return;

            contentManager.delete(id);
            renderContents();
        }

        // Listen to title changes
        document.addEventListener('DOMContentLoaded', function () {
            const titleInput = document.getElementById('page-title');
            const slugInput = document.getElementById('page-slug');

            if (titleInput) {
                titleInput.addEventListener('input', updatePageMetadata);
            }
            if (slugInput) {
                slugInput.addEventListener('input', updatePageMetadata);
            }
        });

        // Update character count
        function updateCharacterCount() {
            if (monacoEditor) {
                const charCount = document.getElementById('html-char-count');
                const content = monacoEditor.getValue();
                if (charCount) {
                    charCount.textContent = `${content.length} caractères`;
                }
            }
        }

        // Update status badge
        function updateStatusBadge() {
            if (monacoEditor) {
                const statusBadge = document.getElementById('page-status-badge');
                const content = monacoEditor.getValue();
                if (statusBadge && content.length > 0) {
                    statusBadge.innerHTML = '<i class="fas fa-circle text-yellow-500 mr-1" style="font-size: 6px;"></i> Modifié';
                    statusBadge.className = 'text-xs px-2 py-1 rounded bg-yellow-900 text-yellow-300';
                }
            }
        }

        // Copy HTML code to clipboard
        function copyHtmlCode() {
            if (monacoEditor) {
                const content = monacoEditor.getValue();
                navigator.clipboard.writeText(content).then(() => {
                    // Visual feedback
                    const btn = event.target.closest('button');
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check"></i> Copié !';
                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                    }, 2000);
                }).catch(err => {
                    console.error('Erreur lors de la copie:', err);
                    alert('Erreur lors de la copie');
                });
            }
        }

        // Open preview in new tab
        function previewPageNewTab() {
            const title = document.getElementById('page-title')?.value.trim();
            const htmlContent = monacoEditor ? monacoEditor.getValue().trim() : '';
            const thumbnail = document.getElementById('page-thumbnail')?.value.trim();
            const metaDesc = document.getElementById('page-meta-desc')?.value.trim();
            const metaKeywords = document.getElementById('page-meta-keywords')?.value.trim();

            if (!title || !htmlContent) {
                alert('Veuillez remplir au moins le titre et le contenu HTML');
                return;
            }

            // Create preview HTML - minimal interference with user's code
            let previewHtml = `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title}</title>
    ${metaDesc ? `<meta name="description" content="${metaDesc}">` : ''}
    ${metaKeywords ? `<meta name="keywords" content="${metaKeywords}">` : ''}
    <style>
        /* Reset minimal pour éviter les interférences */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
${htmlContent}
</body>
</html>`;

            // Open in new tab
            const newTab = window.open('', '_blank');
            newTab.document.write(previewHtml);
            newTab.document.close();
        }

        // Gemini Configuration Functions
        function openGeminiConfig() {
            const modal = document.getElementById('gemini-modal');
            const apiKeyInput = document.getElementById('gemini-api-key');

            if (modal) {
                modal.classList.remove('hidden');
                // Load saved key
                const savedKey = localStorage.getItem('stackpages_gemini_key');
                if (savedKey && apiKeyInput) {
                    apiKeyInput.value = savedKey;
                }
            }
        }

        function closeGeminiConfig() {
            const modal = document.getElementById('gemini-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function saveGeminiConfig() {
            const apiKeyInput = document.getElementById('gemini-api-key');
            if (apiKeyInput) {
                const key = apiKeyInput.value.trim();
                if (key) {
                    localStorage.setItem('stackpages_gemini_key', key);

                    // Show success feedback
                    const btn = document.querySelector('#gemini-modal button[onclick="saveGeminiConfig()"]');
                    const originalContent = btn.innerHTML;

                    btn.innerHTML = '<i class="fas fa-check"></i> Sauvegardé !';
                    btn.classList.remove('from-blue-600', 'to-blue-500');
                    btn.classList.add('from-green-600', 'to-green-500');

                    setTimeout(() => {
                        closeGeminiConfig();
                        // Reset button style after closing
                        setTimeout(() => {
                            btn.innerHTML = originalContent;
                            btn.classList.add('from-blue-600', 'to-blue-500');
                            btn.classList.remove('from-green-600', 'to-green-500');
                        }, 500);
                    }, 1000);
                } else {
                    alert('Veuillez entrer une clé API valide');
                }
            }
        }

        // Close modal when clicking outside
        document.getElementById('gemini-modal')?.addEventListener('click', function (e) {
            if (e.target === this) {
                closeGeminiConfig();
            }
        });

        // Prompt Modal Functions
        function openPromptModal() {
            const modal = document.getElementById('prompt-modal');
            const textarea = document.getElementById('gemini-prompt-input');
            const errorMsg = document.getElementById('generation-error');

            if (modal) {
                modal.classList.remove('hidden');
                if (textarea) {
                    textarea.value = '';
                    textarea.focus();
                }
                if (errorMsg) errorMsg.classList.add('hidden');
            }
        }

        function closePromptModal() {
            const modal = document.getElementById('prompt-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // Close prompt modal when clicking outside
        document.getElementById('prompt-modal')?.addEventListener('click', function (e) {
            if (e.target === this) {
                closePromptModal();
            }
        });

        async function generateCode() {
            const promptInput = document.getElementById('gemini-prompt-input');
            const generateBtn = document.getElementById('generate-btn');
            const btnText = document.getElementById('generate-btn-text');
            const btnIcon = document.getElementById('generate-btn-icon');
            const loadingIcon = document.getElementById('generate-loading');
            const errorDiv = document.getElementById('generation-error');
            const errorMsg = document.getElementById('generation-error-msg');

            const prompt = promptInput?.value.trim();
            const apiKey = localStorage.getItem('stackpages_gemini_key');

            // Validation
            if (!prompt) {
                showError('Veuillez décrire ce que vous souhaitez générer.');
                return;
            }

            if (!apiKey) {
                showError('Clé API Gemini manquante. Veuillez la configurer via l\'icône d\'engrenage.');
                return;
            }

            // UI Loading State
            if (generateBtn) generateBtn.disabled = true;
            if (btnText) btnText.textContent = 'Génération en cours...';
            if (btnIcon) btnIcon.classList.add('hidden');
            if (loadingIcon) loadingIcon.classList.remove('hidden');
            if (errorDiv) errorDiv.classList.add('hidden');

            try {
                // Construct the API request with enriched system instruction
                const systemInstruction = "You are an expert web developer specialized in creating dynamic web pages.\n\n" +
                    "IMPORTANT RULES:\n" +
                    "1. Generate ONLY valid HTML code with Tailwind CSS classes\n" +
                    "2. Do NOT include markdown backticks\n" +
                    "3. Do NOT include explanations or comments outside the code\n" +
                    "4. The code should be complete body content or a full HTML page if requested\n" +
                    "5. Use modern Tailwind CSS utility classes for styling\n" +
                    "6. Always implement loading states and error handling for API calls\n\n" +

                    "STACKPAGES CMS INTERNAL API:\n" +
                    "This CMS has an internal API that provides dynamic content. When the user requests content like blog, videos, podcasts, you MUST use these endpoints:\n\n" +

                    "API ENDPOINTS:\n\n" +
                    "1. /api/posts - Substack Articles\n" +
                    "   Response: Array of objects [{ title, description, content, link, pubDate, author, image }]\n" +
                    "   Note: Use 'content' for full HTML body, 'image' for cover image, 'link' for URL.\n\n" +

                    "2. /api/videos - YouTube Videos\n" +
                    "   Response: Array of objects [{ title, description, link, thumbnail, published }]\n" +
                    "   Note: Use 'link' for URL (convert to embed if needed), 'published' for date.\n\n" +

                    "3. /api/podcasts - Podcast Episodes\n" +
                    "   Response: Array of objects [{ title, description, link, audioUrl, pubDate }]\n" +
                    "   Note: Use 'link' for page URL, 'audioUrl' for mp3 source.\n\n" +

                    "4. /api/metadata - Site Metadata\n" +
                    "   Response: Object { title, description, author, logo, keywords[] }\n\n" +

                    "CODE PATTERN:\n" +
                    "When user requests dynamic content, use this pattern:\n" +
                    "- Create a container div with an ID\n" +
                    "- Add a loading message initially\n" +
                    "- Use fetch() with ABSOLUTE URL: window.location.origin + '/api/endpoint'\n" +
                    "- Check if data is array: if (Array.isArray(data) && data.length > 0)\n" +
                    "- Map the data array to HTML\n" +
                    "- Include error handling with catch()\n\n" +

                    "CRITICAL - API CALLS:\n" +
                    "ALWAYS use absolute URLs for API calls:\n" +
                    "fetch(window.location.origin + '/api/posts')\n" +
                    "NOT just fetch('/api/posts')\n\n" +

                    "EXAMPLE:\n" +
                    "User asks for 'blog' → Generate HTML with fetch(window.location.origin + '/api/posts')\n" +
                    "User asks for 'videos' → Generate HTML with fetch(window.location.origin + '/api/videos')\n" +
                    "User asks for 'podcasts' → Generate HTML with fetch(window.location.origin + '/api/podcasts')\n\n" +

                    "STYLING:\n" +
                    "- Use Tailwind CSS utility classes\n" +
                    "- Make designs modern and responsive\n" +
                    "- Include animations and hover effects\n" +
                    "- Always add loading states and error handling\n\n" +

                    "CRITICAL:\n" +
                    "- JavaScript code MUST be inside script tags at the end\n" +
                    "- Do NOT use external libraries except TailwindCSS\n" +
                    "- Make sure all IDs match between HTML and JavaScript\n" +
                    "- ALWAYS use window.location.origin + '/api/...' for API calls\n" +
                    "- API returns ARRAYS (except metadata), so iterate directly on data, NOT data.posts\n" +
                    "- Use correct field names: 'link' (not url), 'pubDate'/'published' (not date/publishedAt)";

                // Multi-page context for AI - Adapts based on mode
                let multiPageContext = "";

                if (currentProject.pages.length > 1) {
                    const activePage = currentProject.pages.find(p => p.id === currentProject.activePageId);
                    const otherPages = currentProject.pages.filter(p => p.id !== currentProject.activePageId);

                    if (pageMode === 'spa') {
                        // SPA MODE - Encourage single-page application
                        multiPageContext = "\n\n=== SINGLE PAGE APPLICATION (SPA) ===\n" +
                            "RECOMMENDED APPROACH:\n" +
                            "- Create a complete Single Page Application with client-side routing\n" +
                            "- Use JavaScript to handle navigation between sections/pages\n" +
                            "- Include all content in one HTML file with show/hide logic\n" +
                            "- Implement smooth transitions between sections\n\n" +

                            "PROJECT STRUCTURE:\n" +
                            "- Total sections: " + currentProject.pages.length + "\n" +
                            "- Sections to include: " + currentProject.pages.map(p => p.title).join(', ') + "\n" +
                            "- Current focus: " + (activePage?.title || 'Main page') + "\n\n" +

                            "IMPLEMENTATION TIPS:\n" +
                            "- Create navigation menu with smooth scroll or hash routing\n" +
                            "- Use data-section attributes for easy section management\n" +
                            "- Add animations/transitions when switching sections\n" +
                            "- Mobile-friendly navigation (hamburger menu)\n\n" +

                            "DESIGN CONSISTENCY:\n" +
                            "- Unified color scheme throughout the SPA\n" +
                            "- Consistent typography and spacing\n" +
                            "- Same header/footer for all sections\n";
                    } else {
                        // MULTI-PAGE MODE - Traditional separate HTML files
                        multiPageContext = "\n\n=== TRADITIONAL MULTI-PAGE WEBSITE ===\n" +
                            "CRITICAL INSTRUCTIONS:\n" +
                            "- This is a traditional multi-page website with separate HTML files\n" +
                            "- Each page you create is a SEPARATE, STANDALONE HTML document\n" +
                            "- DO NOT create JavaScript routing or page switching logic\n" +
                            "- DO NOT put all content in one page with display:none toggles\n\n" +

                            "CURRENT PAGE INFO:\n" +
                            "- Page you are editing: " + (activePage?.title || 'Untitled') + "\n" +
                            "- Total pages in project: " + currentProject.pages.length + "\n" +
                            "- Other existing pages: " + otherPages.map(p => p.title).join(', ') + "\n\n" +

                            "NAVIGATION BETWEEN PAGES:\n" +
                            "- Use simple <a href='/page-slug.html'> links\n" +
                            "- Example: <a href='/index.html'>Home</a> | <a href='/about.html'>About</a>\n\n" +

                            "DESIGN CONSISTENCY:\n" +
                            "- MAINTAIN the same visual identity across all pages\n" +
                            "- Use the SAME header/navigation structure on every page\n" +
                            "- Keep the same footer design\n\n" +

                            "WHAT TO GENERATE:\n" +
                            "- Generate ONLY the content for: " + (activePage?.title || 'this page') + "\n" +
                            "- Do NOT include content from other pages\n";
                    }
                }

                const fullPrompt = systemInstruction + multiPageContext + "\n\nUser Request: " + prompt;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: fullPrompt
                            }]
                        }]
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error?.message || 'Erreur lors de la communication avec Gemini.');
                }

                // Extract generated text
                let generatedText = data.candidates?.[0]?.content?.parts?.[0]?.text || '';

                // Clean up markdown if present
                generatedText = generatedText.replace(/^```html\s*/i, '').replace(/```\s*$/i, '');

                if (generatedText) {
                    // Update editor
                    if (monacoEditor) {
                        monacoEditor.setValue(generatedText);
                    }
                    closePromptModal();

                    // Show success notification (optional)
                    // alert('Code généré avec succès !');
                } else {
                    throw new Error('Aucun code n\'a été généré.');
                }

            } catch (error) {
                console.error('Gemini Error:', error);
                showError(error.message);
            } finally {
                // Reset UI
                if (generateBtn) generateBtn.disabled = false;
                if (btnText) btnText.textContent = 'Générer le code';
                if (btnIcon) btnIcon.classList.remove('hidden');
                if (loadingIcon) loadingIcon.classList.add('hidden');
            }

            function showError(message) {
                if (errorDiv && errorMsg) {
                    errorMsg.textContent = message;
                    errorDiv.classList.remove('hidden');
                } else {
                    alert(message);
                }
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();

            // Display site domain
            const domainEl = document.getElementById('site-domain');
            if (domainEl) {
                domainEl.textContent = window.location.hostname || 'localhost';
            }

            // Initialize CMS system
            initCMS();

            // Render initial Templates view
            renderTemplates();

            // Initialize Monaco Editor
            initMonacoEditor('');

            // Check if editing existing page
            const urlParams = new URLSearchParams(window.location.search);
            const pageSlug = urlParams.get('page');

            if (pageSlug) {
                // Wait a bit for Monaco to be ready before loading page
                setTimeout(() => loadPageBySlug(pageSlug), 500);
            }
        });

        // Load page by slug from localStorage
        function loadPageBySlug(slug) {
            let pages = [];
            try {
                const stored = localStorage.getItem('stackpages_custom_pages');
                if (stored) {
                    pages = JSON.parse(stored);
                }
            } catch (e) {
                console.error('Error loading pages:', e);
                return;
            }

            const page = pages.find(p => p.slug === slug);

            if (!page) {
                console.error('Page not found:', slug);
                return;
            }

            // Populate form fields
            document.getElementById('page-title').value = page.title || '';
            document.getElementById('page-slug').value = page.slug || '';
            document.getElementById('page-meta-desc').value = page.metaDesc || '';
            document.getElementById('page-meta-keywords').value = page.metaKeywords || '';
            document.getElementById('page-thumbnail').value = page.thumbnail || '';

            // Set Monaco content
            if (monacoEditor && page.htmlContent) {
                monacoEditor.setValue(page.htmlContent);
            }

            // Update status
            const statusText = page.status === 'draft' ? 'Édition: ' + page.title + ' (Brouillon)' : 'Édition: ' + page.title;
            document.getElementById('page-status').textContent = statusText;

            // Update status badge
            const statusBadge = document.getElementById('page-status-badge');
            if (statusBadge && page.status === 'draft') {
                statusBadge.innerHTML = '<i class="fas fa-circle text-orange-500 mr-1" style="font-size: 6px;"></i> Brouillon';
                statusBadge.className = 'text-xs px-2 py-1 rounded bg-orange-900 text-orange-300';
            } else if (statusBadge) {
                statusBadge.innerHTML = '<i class="fas fa-circle text-green-500 mr-1" style="font-size: 6px;"></i> Publié';
                statusBadge.className = 'text-xs px-2 py-1 rounded bg-green-900 text-green-300';
            }

            // Update character count
            updateCharacterCount();
        }

        // Close modal
        function closeModal() {
            document.getElementById('preview-modal').classList.add('hidden');
            const content = document.getElementById('modal-content');
            content.innerHTML = '';
        }

        function switchToVisual() {
            const slug = document.getElementById('page-slug').value;
            if (slug) {
                // Save draft before switching
                // We can reuse savePage('draft') logic but we need to be careful about async
                // Let's manually save to localStorage to be sure

                const title = document.getElementById('page-title').value;
                const htmlContent = monacoEditor ? monacoEditor.getValue() : '';
                const metaDesc = document.getElementById('page-meta-desc').value;
                const metaKeywords = document.getElementById('page-meta-keywords').value;
                const thumbnail = document.getElementById('page-thumbnail').value;

                try {
                    const stored = localStorage.getItem('stackpages_custom_pages');
                    const pages = stored ? JSON.parse(stored) : [];
                    const pageIndex = pages.findIndex(p => p.slug === slug);

                    if (pageIndex !== -1) {
                        pages[pageIndex].title = title;
                        pages[pageIndex].htmlContent = htmlContent;
                        pages[pageIndex].metaDesc = metaDesc;
                        pages[pageIndex].metaKeywords = metaKeywords;
                        pages[pageIndex].thumbnail = thumbnail;
                        pages[pageIndex].updatedAt = new Date().toISOString();
                        // Keep status as is or set to draft? Let's keep as is.

                        localStorage.setItem('stackpages_custom_pages', JSON.stringify(pages));

                        // Redirect
                        window.location.href = `/admin/visual-editor.html?page=${slug}`;
                    } else {
                        // New page not saved yet?
                        alert("Veuillez d'abord sauvegarder la page (Brouillon) avant de changer de mode.");
                    }
                } catch (e) {
                    console.error("Error saving before switch:", e);
                    alert("Erreur lors de la sauvegarde avant le changement de mode.");
                }
            } else {
                window.location.href = '/admin/visual-editor.html';
            }
        }
    </script>
</body>

</html>